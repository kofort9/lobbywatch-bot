name: LDA Quarterly Update

on:
  schedule:
    # Run on the 15th of each month at 08:00 UTC (quarterly filings are due 45 days after quarter end)
    - cron: "0 8 15 * *"
  workflow_dispatch:
    inputs:
      mode:
        description: 'Update mode'
        required: true
        default: 'update'
        type: choice
        options:
        - update
        - backfill
      start_year:
        description: 'Start year (for backfill mode)'
        required: false
        type: string
      end_year:
        description: 'End year (for backfill mode)'
        required: false
        type: string

jobs:
  lda-update:
    name: Update LDA Data
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run LDA quarterly update
        if: ${{ github.event.inputs.mode != 'backfill' }}
        env:
          ENABLE_LDA_V1: true
          LDA_DATA_SOURCE: api
          LDA_API_KEY: ${{ secrets.LDA_API_KEY }}
          LDA_API_BASE_URL: https://lda.senate.gov/api/v1/
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_SIGNING_SECRET: ${{ secrets.SLACK_SIGNING_SECRET }}
          LOBBYLENS_CHANNELS: ${{ secrets.LOBBYLENS_CHANNELS }}
          LOBBYLENS_ADMIN_USER_ID: ${{ secrets.LOBBYLENS_ADMIN_USER_ID }}
          LOG_LEVEL: INFO
        run: |
          python -c "
          import os
          import sys
          sys.path.insert(0, '.')
          
          from bot.lda_scheduler import LDAScheduler
          from bot.lda_front_page_digest import LDAFrontPageDigest
          from bot.database_postgres import create_database_manager
          from bot.slack_app import SlackApp
          
          print('üîÑ Starting LDA quarterly update...')
          
          # Run ETL
          scheduler = LDAScheduler()
          result = scheduler.run_quarterly_update()
          print(f'‚úÖ ETL completed: {result}')
          
          # Post digest to channels if ETL successful
          if result.get('status') == 'success':
              print('üì§ Posting LDA digest to Slack channels...')
              
              channels = os.getenv('LOBBYLENS_CHANNELS', '').split(',')
              if channels and channels[0]:
                  db_manager = create_database_manager()
                  digest_generator = LDAFrontPageDigest(db_manager)
                  slack_app = SlackApp(db_manager, digest_generator)
                  
                  for channel_id in channels:
                      channel_id = channel_id.strip()
                      if channel_id:
                          try:
                              digest = digest_generator.generate_digest(channel_id)
                              slack_app.post_message(channel_id, digest)
                              print(f'‚úÖ Posted digest to channel {channel_id}')
                          except Exception as e:
                              print(f'‚ùå Failed to post to channel {channel_id}: {e}')
              else:
                  print('‚ö†Ô∏è No channels configured in LOBBYLENS_CHANNELS')
          else:
              print('‚ö†Ô∏è ETL failed, skipping digest posting')
          "

      - name: Run LDA backfill
        if: ${{ github.event.inputs.mode == 'backfill' }}
        env:
          ENABLE_LDA_V1: true
          LDA_DATA_SOURCE: api
          LDA_API_KEY: ${{ secrets.LDA_API_KEY }}
          LDA_API_BASE_URL: https://lda.senate.gov/api/v1/
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          LOG_LEVEL: INFO
        run: |
          python -m bot.lda_scheduler backfill ${{ github.event.inputs.start_year }} ${{ github.event.inputs.end_year }}

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: lda-update-logs
          path: "*.log"
          retention-days: 7
