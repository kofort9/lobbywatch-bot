# LobbyLens Improvements

Actionable upgrades to tighten the current V2 (daily government activity) experience and keep it aligned with the documented feature set.

## Channel Expansion (Slack-Optional)
- **Analyst Dashboard (FastAPI + minimal frontend)**: Stand up a read-only web UI to browse/filter signals, watchlists, and comment surges with saved queries. MVP tasks: (1) expose a paginated `/api/signals` with filters (source, agency, issue codes, priority, date window, watchlist hit), (2) add `/api/watchlist` read endpoints, (3) ship a small FastAPI+Jinja or static-HTML front page that calls those APIs, (4) include “since last login” filter using a per-user session timestamp, and (5) add CSV and Parquet export endpoints for current result sets.
- **Email digests (cheaper test channel)**: Reuse `DigestFormatter` output and add an email notifier alongside Slack. Tasks: (1) add SMTP/SendGrid config to `settings`, (2) create `EmailNotifier` with plain-text (and optional HTML) support, (3) wire `bot/run.py` to choose notifier by config, (4) add CLI flag for `--channel email` to aid testing, (5) write a smoke test that captures the email payload without sending. Document per-env credentials and throttling for local/CI. See `docs/EMAIL_SETUP.md` for a free local SMTP workflow. **Status:** notifier wired; multipart HTML/text supported; HTML templating uses basic Markdown (links, bold, bullets) for now.
- **API shapes (for dashboard stubbing)**:
  - `/api/signals` (GET): query params `page`, `page_size`, `source`, `agency`, `issue_codes[]`, `min_priority`, `since_ts`, `watchlist_hit`. Response: `{"items":[{"id":"regulations_gov:ABC123","source":"regulations_gov","timestamp":"2024-10-30T12:00:00Z","title":"...", "link":"...", "agency":"...", "issue_codes":["TEC"], "priority_score":4.1, "watchlist_hit":true, "comment_end_date":"...", "comments_24h":12}], "page":1,"page_size":50,"total":1234,"export":{"csv":"/api/signals/export.csv?...","parquet":"/api/signals/export.parquet?..."}}`
  - `/api/watchlist` (GET): optional `channel_id`. Response: `{"channel_id":"C123","items":[{"term":"Google","type":"entity"},{"term":"AI","type":"keyword"}]}`. Add `/api/watchlist/<term>` DELETE for removals and POST `{term,type}` for adds later.
  - `/api/signals/export.csv` (GET): CSV export with same filters as `/api/signals`. Parquet export endpoint stubbed, to be filled when a columnar dependency is added.
  - `/health` (GET): returns `{status, database, service}`; `/metrics` exposes Prometheus-style gauges (totals, recent, by source).

## High-Impact Next Steps
- **Persist watchlists and thresholds for V2 Slack commands**: `/watchlist` and `/threshold` now back onto real tables via `SignalsDatabaseV2`. Remaining work: wire Slack signature verification, ensure watchlist/threshold changes are reflected in collector instances across long-lived processes, and move signals storage to Postgres in production.
- **Save collected signals before formatting**: `run_daily_digest`/`run_mini_digest` now persist signals; next step is to reuse DB stats for `/lobbylens` status and “since last run” diffs, and deduplicate more aggressively.
- **Harden Slack HTTP entrypoints**: The Flask endpoints in `bot/web_server.py` accept unauthenticated POSTs. Port the `SlackApp.verify_slack_request` flow from `bot/slack_app.py`, enforce signing secrets in production, and reuse the richer `SlackApp` command handlers so admin checks and confirmations are honored.
- **Add request resilience for external APIs**: Calls to Congress.gov, Federal Register, and Regulations.gov in `bot/daily_signals.py` use a shared `requests.Session` with no timeout, retry, or backoff logic. Add sane defaults (e.g., 10–15s timeouts, capped retries with jitter) and surface failures via structured logs/metrics to avoid hung digest runs.
- **Right-size Regulations.gov ingestion**: `_collect_regulations_gov_signals` currently paginates up to 1000 docs and fetches per-docket comment metrics synchronously. Introduce stricter caps (or incremental cursors), short-circuit when budgets are hit, and cache detail/comment lookups to keep 4–24h digests under Slack’s 3s response window.
- **Align V2 storage with production**: `SignalsDatabaseV2` defaults to a local SQLite `signals.db`, while the README positions Railway/Postgres as the production store. Decide on the canonical backend, add migrations, and wire environment selection so web, CLI, and workers all hit the same datastore.
- **Add end-to-end coverage for the V2 path**: New tests should exercise `/lobbypulse` end-to-end with saved signals, watchlist hits, and mini-digest thresholds to prevent regressions as the plumbing is tightened.
- **Document and integrate GovSearch service**: The `govsearch/` FastAPI search service and Streamlit UI are untracked and undocumented. Add to README architecture section, document API endpoints, add deployment instructions, and clarify integration with main LobbyLens system (shared database, separate service, or standalone).
- **Implement structured logging and metrics**: Add structured JSON logging with correlation IDs, integrate metrics collection (Prometheus/StatsD), and create dashboards for API health, digest generation times, and error rates. Surface metrics via `/metrics` endpoint for monitoring tools.
- **Add data retention and cleanup policies**: Implement automated archival of old `signal_event` rows (e.g., keep 90 days hot, archive older), add cleanup jobs for SQLite databases, and document retention policies. Consider partitioning PostgreSQL tables by date for efficient pruning.
- **Standardize error handling patterns**: Create a common error handling module with error classes, standardized response formats, and error classification (transient vs. permanent). Apply consistently across `bot/web_server.py`, `bot/run.py`, and API clients. Add error context propagation for debugging.
- **Implement rate limiting and circuit breakers**: Add rate limiting middleware for external API calls (Congress, Federal Register, Regulations.gov) with per-API quotas, implement circuit breakers to fail fast when APIs are down, and add exponential backoff with jitter for retries. Track rate limit exhaustion as metrics.
- **Enhance health check endpoints**: Expand `/health` endpoints to check database connectivity, external API reachability, and recent digest generation success. Add `/ready` endpoint for Kubernetes-style readiness probes. Return structured health status with component-level details.
- **Create backup and disaster recovery procedures**: Document PostgreSQL backup/restore procedures (Railway managed backups), add SQLite backup scripts for local development, define RTO/RPO targets, and create a testing schedule for restore procedures. Document failover scenarios.
- **Add dependency security scanning**: Integrate automated dependency scanning (Dependabot, Snyk, or similar) to detect vulnerable packages, add security update policies (auto-merge patch updates, review minor/major), and document the update process in operations guide.
